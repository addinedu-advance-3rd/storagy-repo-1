<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡œë´‡ ìœ„ì¹˜ ì§€ë„</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 {
            color: #333;
        }
        #map-container {
            position: relative;
            margin-top: 20px;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 800px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
            overflow: hidden;
        }
        #map-image {
            display: block;
            width: 100%; /* ì»¨í…Œì´ë„ˆì— ë§ê²Œ ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • */
            height: auto;
        }
        #robot-marker {
            position: absolute;
            width: 16px; /* ë§ˆì»¤ í¬ê¸° ì¦ê°€ */
            height: 16px; /* ë§ˆì»¤ í¬ê¸° ì¦ê°€ */
            background-color: red;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        #fod-marker {
        position: absolute;
        width: 10px; /* ë§ˆì»¤ í¬ê¸° */
        height: 10px; /* ë§ˆì»¤ í¬ê¸° */
        background-color: green; /* ì´ˆë¡ìƒ‰ ë§ˆì»¤ */
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }

        #robot-direction {
            position: absolute;
            width: 30px; /* ë°©í–¥ í‘œì‹œ ê¸¸ì´ ì¦ê°€ */
            height: 3px; /* ë°©í–¥ í‘œì‹œ ë‘ê»˜ ì¦ê°€ */
            background-color: blue;
            transform-origin: left center;
            z-index: 9;
        }
        #status {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ë¡œë´‡ ìœ„ì¹˜ ì§€ë„</h1>
    <div id="status">ì—°ê²° ì¤‘...</div>
    <div id="map-container">
        <img id="map-image" src="/map-image" alt="ì§€ë„ ì´ë¯¸ì§€">
        <!-- <img id="map-image" src="/map-image?no_cv=true" alt="ì§€ë„ ì´ë¯¸ì§€"> -->
        <div id="robot-marker" style="display:none;"></div>
        <div id="robot-direction" style="display:none;"></div>
        <div id="fod-marker" style="display:none;"></div>
    </div>

    <script>
        // ì›¹ì†Œì¼“ ì—°ê²° ë° ì¬ì—°ê²° ê´€ë¦¬
        let socket;
        let reconnectInterval = 1000; // ì´ˆê¸° ì¬ì—°ê²° ê°„ê²© (1ì´ˆ)
        let maxReconnectInterval = 30000; // ìµœëŒ€ ì¬ì—°ê²° ê°„ê²© (30ì´ˆ)
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10; // ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜
        let pingInterval;
        
        const statusElement = document.getElementById('status');
        const robotMarker = document.getElementById('robot-marker');
        const robotDirection = document.getElementById('robot-direction');
        const mapContainer = document.getElementById('map-container');
        const mapImage = document.getElementById('map-image');
        
        // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • ë¹„ìœ¨ ê³„ì‚°ì„ ìœ„í•œ ë³€ìˆ˜
        let originalWidth = 0;
        let originalHeight = 0;
        let scaleRatio = 1;
        
        // ë§ˆì§€ë§‰ìœ¼ë¡œ ìˆ˜ì‹ í•œ ë¡œë´‡ ìœ„ì¹˜ ë°ì´í„° ì €ì¥
        let lastRobotData = null;
        
        // ì›¹ì†Œì¼“ ì—°ê²° í•¨ìˆ˜
        function connectWebSocket() {
            // ì´ì „ ì†Œì¼“ì´ ìˆìœ¼ë©´ ì •ë¦¬
            if (socket) {
                socket.onopen = null;
                socket.onclose = null;
                socket.onerror = null;
                socket.onmessage = null;
                socket.close();
            }
            
            // í˜„ì¬ í˜¸ìŠ¤íŠ¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            const host = window.location.hostname;
            const port = 8765; // ì›¹ì†Œì¼“ í¬íŠ¸
            
            // ìƒˆ ì›¹ì†Œì¼“ ì—°ê²° ìƒì„±
            console.log(`ì›¹ì†Œì¼“ ì—°ê²° ì‹œë„: ws://${host}:${port}`);
            socket = new WebSocket(`ws://${host}:${port}`);
            
            socket.onopen = function() {
                console.log("ì›¹ì†Œì¼“ ì—°ê²°ë¨");
                statusElement.textContent = 'ì—°ê²°ë¨';
                statusElement.style.backgroundColor = '#d4edda';
                
                // ì—°ê²° ì„±ê³µ ì‹œ ì¬ì—°ê²° ì¹´ìš´í„° ì´ˆê¸°í™”
                reconnectAttempts = 0;
                reconnectInterval = 1000;
                
                // ì—°ê²° ìœ ì§€ë¥¼ ìœ„í•œ í•‘ ë©”ì‹œì§€ ì „ì†¡ (30ì´ˆë§ˆë‹¤)
                if (pingInterval) {
                    clearInterval(pingInterval);
                }
                pingInterval = setInterval(function() {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000);
            };
            
            socket.onclose = function(event) {
                console.log("ì›¹ì†Œì¼“ ì—°ê²° ëŠê¹€", event);
                statusElement.textContent = 'ì—°ê²° ëŠê¹€ - ì¬ì—°ê²° ì¤‘...';
                statusElement.style.backgroundColor = '#f8d7da';
                
                // í•‘ ì¸í„°ë²Œ ì •ë¦¬
                if (pingInterval) {
                    clearInterval(pingInterval);
                }
                
                // ì¬ì—°ê²° ì‹œë„
                if (reconnectAttempts < maxReconnectAttempts) {
                    setTimeout(function() {
                        reconnectAttempts++;
                        connectWebSocket();
                        // ì§€ìˆ˜ ë°±ì˜¤í”„ë¡œ ì¬ì—°ê²° ê°„ê²© ì¦ê°€
                        reconnectInterval = Math.min(reconnectInterval * 1.5, maxReconnectInterval);
                    }, reconnectInterval);
                } else {
                    statusElement.textContent = 'ì—°ê²° ì‹¤íŒ¨ - í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”';
                }
            };
            
            socket.onerror = function(error) {
                console.error("ì›¹ì†Œì¼“ ì˜¤ë¥˜:", error);
                statusElement.textContent = 'ì—°ê²° ì˜¤ë¥˜ ë°œìƒ';
                statusElement.style.backgroundColor = '#f8d7da';
            };
            
            socket.onmessage = function(event) {
                console.log("ì›¹ì†Œì¼“ ë©”ì‹œì§€ ìˆ˜ì‹ :", event.data);
                try {
                    const data = JSON.parse(event.data);
                    
                    // ë¡œë´‡ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    if (data.type === 'robot_pose') {
                        console.log("ë¡œë´‡ ìœ„ì¹˜ ë°ì´í„° ìˆ˜ì‹ :", data);
                        
                        // ë°ì´í„° ì €ì¥
                        lastRobotData = data;
                        
                        // ë¡œë´‡ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                        updateRobotPosition(data);

                        //FOD ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                        updateFODPosition(data);
                    }
                } catch (e) {
                    console.error("ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:", e);
                }
            };
        }
        
        // ë¡œë´‡ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateRobotPosition(data) {
            // ë§ˆì»¤ì™€ ë°©í–¥ í‘œì‹œ ìš”ì†Œ í‘œì‹œ
            robotMarker.style.display = 'block';
            robotDirection.style.display = 'block';
            
            // ì„œë²„ì—ì„œ ë°›ì€ ì´ë¯¸ì§€ í¬ê¸° ì •ë³´ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            if (data.img_width && data.img_height) {
                // ì„œë²„ ì´ë¯¸ì§€ í¬ê¸°ì™€ í˜„ì¬ í‘œì‹œ ì´ë¯¸ì§€ í¬ê¸°ì˜ ë¹„ìœ¨ ê³„ì‚°
                const widthRatio = mapImage.width / data.img_width;
                const heightRatio = mapImage.height / data.img_height;
                
                // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • ë¹„ìœ¨ ì ìš©
                const scaledX = data.pixel_x * widthRatio;
                const scaledY = data.pixel_y * heightRatio;
                
                console.log(`ì„œë²„ ì´ë¯¸ì§€ í¬ê¸°: ${data.img_width}x${data.img_height}`);
                console.log(`í˜„ì¬ ì´ë¯¸ì§€ í¬ê¸°: ${mapImage.width}x${mapImage.height}`);
                console.log(`ë„ˆë¹„ ë¹„ìœ¨: ${widthRatio}, ë†’ì´ ë¹„ìœ¨: ${heightRatio}`);
                console.log(`ì›ë³¸ í”½ì…€ ì¢Œí‘œ: (${data.pixel_x}, ${data.pixel_y})`);
                console.log(`ì¡°ì •ëœ í”½ì…€ ì¢Œí‘œ: (${scaledX}, ${scaledY})`);
                
                // í”½ì…€ ì¢Œí‘œë¡œ ë¡œë´‡ ë§ˆì»¤ ìœ„ì¹˜ ì„¤ì •
                robotMarker.style.left = `${scaledX}px`;
                robotMarker.style.top = `${scaledY}px`;
                
                // ë¡œë´‡ ë°©í–¥ í‘œì‹œ (ì‹œê³„ë°©í–¥ +90ë„ ë³´ì •)
                const directionLength = 30; // ë°©í–¥ í‘œì‹œ ê¸¸ì´
                robotDirection.style.left = `${scaledX}px`;
                robotDirection.style.top = `${scaledY}px`;
                robotDirection.style.width = `${directionLength}px`;
                robotDirection.style.transform = `rotate(${data.yaw_deg + 90}deg)`;
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                statusElement.textContent = `ë¡œë´‡ ìœ„ì¹˜: x=${data.robot_x.toFixed(2)}m, y=${data.robot_y.toFixed(2)}m, í”½ì…€: (${Math.round(scaledX)}, ${Math.round(scaledY)})`;
            } else {
                // ì´ì „ ë°©ì‹ (ì„œë²„ì—ì„œ ì´ë¯¸ì§€ í¬ê¸° ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°)
                const scaledX = data.pixel_x * scaleRatio;
                const scaledY = data.pixel_y * scaleRatio;
                
                console.log(`ì›ë³¸ í”½ì…€ ì¢Œí‘œ: (${data.pixel_x}, ${data.pixel_y})`);
                console.log(`ìŠ¤ì¼€ì¼ ë¹„ìœ¨: ${scaleRatio}`);
                console.log(`ì¡°ì •ëœ í”½ì…€ ì¢Œí‘œ: (${scaledX}, ${scaledY})`);
                
                // í”½ì…€ ì¢Œí‘œë¡œ ë¡œë´‡ ë§ˆì»¤ ìœ„ì¹˜ ì„¤ì •
                robotMarker.style.left = `${scaledX}px`;
                robotMarker.style.top = `${scaledY}px`;
                
                // ë¡œë´‡ ë°©í–¥ í‘œì‹œ (ì‹œê³„ë°©í–¥ +90ë„ ë³´ì •)
                const directionLength = 30; // ë°©í–¥ í‘œì‹œ ê¸¸ì´
                robotDirection.style.left = `${scaledX}px`;
                robotDirection.style.top = `${scaledY}px`;
                robotDirection.style.width = `${directionLength}px`;
                robotDirection.style.transform = `rotate(${data.yaw_deg - 90}deg)`;
                
                // ìƒíƒœ ì—…ë°ì´íŠ¸
                statusElement.textContent = `ë¡œë´‡ ìœ„ì¹˜: x=${data.robot_x.toFixed(2)}m, y=${data.robot_y.toFixed(2)}m, í”½ì…€: (${Math.round(scaledX)}, ${Math.round(scaledY)})`;
            }
        }
        // FOD ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateFODPosition(data) {
            const fodMarker = document.getElementById('fod-marker');

            if (data.fod_x !== undefined && data.fod_y !== undefined) {
                // ì§€ë„ í¬ê¸° ë¹„ìœ¨ ê³„ì‚°
                const widthRatio = mapImage.width / data.img_width;
                const heightRatio = mapImage.height / data.img_height;

                // FOD í”½ì…€ ì¢Œí‘œ ë³€í™˜
                const adjustedFodX = data.fod_x * widthRatio;
                const adjustedFodY = mapImage.height - (data.fod_y * heightRatio);  // âœ… yì¶• ë°˜ì „ ì ìš©

                console.log(`ğŸ“Œ FOD ì›ë³¸ í”½ì…€ ì¢Œí‘œ: (${data.fod_x}, ${data.fod_y})`);
                console.log(`ğŸ“Œ ì¡°ì •ëœ FOD ì¢Œí‘œ: (${adjustedFodX}, ${adjustedFodY})`);

                // FOD ë§ˆì»¤ ìœ„ì¹˜ ì„¤ì •
                fodMarker.style.left = `${adjustedFodX}px`;
                fodMarker.style.top = `${adjustedFodY}px`;
                fodMarker.style.display = 'block'; // í‘œì‹œ
            } else {
                console.log("âš ï¸ FOD ë°ì´í„° ì—†ìŒ");
                fodMarker.style.display = 'none'; // ìˆ¨ê¹€
            }
        }


        
        // ì´ˆê¸° ì›¹ì†Œì¼“ ì—°ê²°
        connectWebSocket();
        
        // ì§€ë„ ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì»¨í…Œì´ë„ˆ í¬ê¸° ì¡°ì •
        mapImage.onload = function() {
            // ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° ì €ì¥
            originalWidth = mapImage.naturalWidth;
            originalHeight = mapImage.naturalHeight;
            
            // í˜„ì¬ í‘œì‹œ í¬ê¸°ì™€ ì›ë³¸ í¬ê¸°ì˜ ë¹„ìœ¨ ê³„ì‚°
            scaleRatio = mapImage.width / originalWidth;
            
            console.log(`ì´ë¯¸ì§€ í¬ê¸° ì¡°ì • ë¹„ìœ¨: ${scaleRatio}`);
            console.log(`ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸°: ${originalWidth}x${originalHeight}`);
            console.log(`í‘œì‹œ ì´ë¯¸ì§€ í¬ê¸°: ${mapImage.width}x${mapImage.height}`);
            
            // ì»¨í…Œì´ë„ˆ ë†’ì´ ìë™ ì¡°ì •
            mapContainer.style.height = `${mapImage.height}px`;
            
            // ì´ë¯¸ì§€ê°€ ë¡œë“œëœ í›„ ì €ì¥ëœ ë¡œë´‡ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
            if (lastRobotData) {
                updateRobotPosition(lastRobotData);
            }
        };
        
        // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë¹„ìœ¨ ì¬ê³„ì‚° ë° ë¡œë´‡ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        window.addEventListener('resize', function() {
            if (originalWidth > 0) {
                // ìƒˆ ë¹„ìœ¨ ê³„ì‚°
                scaleRatio = mapImage.width / originalWidth;
                console.log(`ì°½ í¬ê¸° ë³€ê²½ - ìƒˆ ë¹„ìœ¨: ${scaleRatio}`);
                
                // ì»¨í…Œì´ë„ˆ ë†’ì´ ì¡°ì •
                mapContainer.style.height = `${mapImage.height}px`;
                
                // ì €ì¥ëœ ë¡œë´‡ ìœ„ì¹˜ê°€ ìˆìœ¼ë©´ ìƒˆ ë¹„ìœ¨ë¡œ ì—…ë°ì´íŠ¸
                if (lastRobotData) {
                    updateRobotPosition(lastRobotData);
                }
            }
        });
    </script>
</body>
</html>
