{% extends "base.html" %}
{% block content %}
<div class="modal" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">09bot</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalBody">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">í™•ì¸</button>
        </div>
      </div>
    </div>
  </div>


<div class="container">
    <!--ì§€ë„ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸° --> 
    <div class="text-center" style="overflow: hidden; width: 100%; height: 70vh;">
      <iframe id="mapFrame" src="http://127.0.0.1:8000/" width="100%" height="100%" style="border: none;" scrolling="no"></iframe>
    </div>

    <script>
      // ì§€ë„ ã……ë¡œê³ ì¹¨
      function refreshMap() {
          var frame = document.getElementById("mapFrame");
          frame.src = "http://127.0.0.1:8000/";  // ìë™ ìƒˆë¡œê³ ì¹¨
      }
      setInterval(refreshMap, 1000);  // 1ì´ˆë§ˆë‹¤ ìµœì‹  í˜ì´ì§€ ë¡œë“œ
  </script>
</div>




<!-- ë¡œë´‡ í˜¸ì¶œ ë²„íŠ¼ (âœ… callRobot í˜¸ì¶œí•˜ë„ë¡ ìˆ˜ì •) -->
<div class="text-center mt-4">
  <button id="areaA" class="btn btn-secondary btn-lg" >Aêµ¬ì—­ í˜¸ì¶œ</button>
  <button id="areaB" class="btn btn-secondary btn-lg" >Bêµ¬ì—­ í˜¸ì¶œ</button>
  <button class="btn btn-secondary btn-lg" onclick="callRobot('Home')">Home í˜¸ì¶œ</button>
</div>
</div>


<!-- ë¡œë´‡ í˜¸ì¶œ í•˜ë“œ ì½”ë”© ë²„ì „ Home -->
<script>
  /**
   * ğŸ“Œ ë¡œë´‡ í˜¸ì¶œ ìš”ì²­ ì²˜ë¦¬ í•¨ìˆ˜
   * ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ì„ ë„ìš°ê³  Flask ì„œë²„(`/move`)ë¡œ ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
   * @param {string} zone 'Home' (í˜¸ì¶œí•  êµ¬ì—­)
   */
  function callRobot(zone) {
      console.log(`ğŸ“¢ [${zone}] ì‹¤í–‰ ìš”ì²­`);
      // âœ… 1ï¸âƒ£ ì‚¬ìš©ìì—ê²Œ ëª¨ë‹¬ ë©”ì‹œì§€ í‘œì‹œ
      document.getElementById('modalBody').innerText = zone + 'êµ¬ì—­ìœ¼ë¡œ ì´ë™ ì¤‘.';
      $('#alertModal').modal('show');

      // âœ… 2ï¸âƒ£ Flask ì„œë²„ë¡œ ì´ë™ ìš”ì²­ ì „ì†¡
      fetch('http://127.0.0.1:5050/move', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify({ zone: zone })  // êµ¬ì—­(A/B) ì •ë³´ ì „ì†¡
      })
      .then(response => response.json())  // ì„œë²„ ì‘ë‹µì„ JSONìœ¼ë¡œ ë³€í™˜
      .then(data => {
          console.log('[${zone}] ì„œë²„ ì‘ë‹µ:', data);  // ë””ë²„ê¹…ìš© ì½˜ì†” ì¶œë ¥
      })
      .catch(error => {
          console.error('ì˜¤ë¥˜ ë°œìƒ:', error);
      });
  }
</script>


{% endblock %}

{% block script %}
<!-- A, B í˜¸ì¶œ = ì›¹ ì†Œì¼“-->
<script>
  const socket = new WebSocket('ws://192.168.0.6:9090');

  socket.onopen = () => {
    console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ!');

    document.getElementById('areaA').addEventListener('click', function () {
      const position = { x: -0.046, y: -1.063, z: 0.0 };
      const orientation = { z: -0.565, w: 0.825 };

      console.log(`ğŸ“¢ [Aêµ¬ì—­] ì´ë™ ëª…ë ¹ ì „ì†¡! (ì¢Œí‘œ: x=${position.x}, y=${position.y}, z=${position.z})`);

      const actionCall = {
        op: 'send_action_goal',
        action: '/navigate_to_pose',
        action_type: 'nav2_msgs/action/NavigateToPose',
        args: {
          pose: {
            header: {
              stamp: {},
              frame_id: 'map'
            },
            pose: {
              position: position,
              orientation: orientation
            }
          }
        }
      };

      socket.send(JSON.stringify(actionCall));
      console.log(`ğŸš€ [Aêµ¬ì—­] ë¡œë´‡ ì´ë™ ìš”ì²­ ì™„ë£Œ! (ë°©í–¥: z=${orientation.z}, w=${orientation.w})`);
    });

    document.getElementById('areaB').addEventListener('click', function () {
      const position = { x: 0.188, y: 0.871, z: 0.0 };
      const orientation = { z: 0.743, w: 0.668 };

      console.log(`ğŸ“¢ [Bêµ¬ì—­] ì´ë™ ëª…ë ¹ ì „ì†¡! (ì¢Œí‘œ: x=${position.x}, y=${position.y}, z=${position.z})`);

      const actionCall = {
        op: 'send_action_goal',
        action: '/navigate_to_pose',
        action_type: 'nav2_msgs/action/NavigateToPose',
        args: {
          pose: {
            header: {
              stamp: {},
              frame_id: 'map'
            },
            pose: {
              position: position,
              orientation: orientation
            }
          }
        }
      };

      socket.send(JSON.stringify(actionCall));
      console.log(`ğŸš€ [Bêµ¬ì—­] ë¡œë´‡ ì´ë™ ìš”ì²­ ì™„ë£Œ! (ë°©í–¥: z=${orientation.z}, w=${orientation.w})`);
    });
  };

  socket.onmessage = (event) => {
    const response = JSON.parse(event.data);
    console.log('ğŸ“© WebSocket ì‘ë‹µ ìˆ˜ì‹ :', response);

    if (response.op === 'action_result') {
      console.log('âœ… [ì‘ë‹µ] ì•¡ì…˜ ê²°ê³¼:', response.result);
    } else if (response.op === 'action_feedback') {
      console.log('ğŸ“¡ [í”¼ë“œë°±] ì§„í–‰ ìƒíƒœ:', response.feedback);
    } else if (response.op === 'status') {
      console.log('ğŸ“Œ [ìƒíƒœ] í˜„ì¬ ë¡œë´‡ ì•¡ì…˜ ìƒíƒœ:', response.values);
    }
  };

  socket.onclose = () => {
    console.log('âŒ WebSocket ì—°ê²° ì¢…ë£Œë¨! ì¬ì—°ê²° í•„ìš”!');
  };
</script>

{% endblock %}