{% extends 'base.html' %}
{% block content %}
<div class="container my-3">
    <h2 class="border-bottom py-2">로봇 위치 지도</h2>
    <div class="row">
        <div class="col-12">
            <div id="map-container" class="border p-3 mb-3">
                <img id="map-image" src="http://localhost:8080/map-image" class="img-fluid" alt="지도 이미지">
                <div id="robot-marker" style="position: absolute; display: none;">
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <circle cx="10" cy="10" r="8" fill="red" />
                        <line x1="10" y1="10" x2="10" y2="2" stroke="blue" stroke-width="2" id="direction-line" />
                    </svg>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">로봇 위치 정보</div>
                <div class="card-body">
                    <p>X 좌표: <span id="robot-x">-</span> m</p>
                    <p>Y 좌표: <span id="robot-y">-</span> m</p>
                    <p>방향: <span id="robot-yaw">-</span> 도</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const mapContainer = document.getElementById('map-container');
        const mapImage = document.getElementById('map-image');
        const robotMarker = document.getElementById('robot-marker');
        const directionLine = document.getElementById('direction-line');
        const robotX = document.getElementById('robot-x');
        const robotY = document.getElementById('robot-y');
        const robotYaw = document.getElementById('robot-yaw');
        
        // 웹소켓 연결
        const socket = new WebSocket('ws://localhost:8765');
        
        socket.onopen = function(e) {
            console.log('웹소켓 연결 성공');
        };
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === 'robot_pose') {
                // 로봇 위치 정보 업데이트
                robotX.textContent = data.robot_x.toFixed(2);
                robotY.textContent = data.robot_y.toFixed(2);
                robotYaw.textContent = data.yaw_deg.toFixed(2);
                
                // 지도 이미지 위에 로봇 마커 표시
                const imgRect = mapImage.getBoundingClientRect();
                
                // 이미지 크기에 맞게 픽셀 좌표 조정
                const scaleX = imgRect.width / mapImage.naturalWidth;
                const scaleY = imgRect.height / mapImage.naturalHeight;
                
                const markerX = data.pixel_x * scaleX;
                const markerY = data.pixel_y * scaleY;
                
                // 마커 위치 설정
                robotMarker.style.display = 'block';
                robotMarker.style.position = 'absolute';
                robotMarker.style.left = `${markerX - 10}px`;
                robotMarker.style.top = `${markerY - 10}px`;
                
                // 방향 표시선 회전
                const radians = data.yaw_deg * Math.PI / 180;
                const endX = 10 + 8 * Math.cos(radians);
                const endY = 10 - 8 * Math.sin(radians);
                directionLine.setAttribute('x2', endX);
                directionLine.setAttribute('y2', endY);
            }
        };
        
        socket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`웹소켓 연결 종료, 코드=${event.code} 이유=${event.reason}`);
            } else {
                console.log('웹소켓 연결이 끊어졌습니다');
            }
        };
        
        socket.onerror = function(error) {
            console.log(`웹소켓 오류: ${error.message}`);
        };
        
        // 지도 이미지 로드 시 컨테이너 스타일 설정
        mapImage.onload = function() {
            mapContainer.style.position = 'relative';
            mapContainer.style.width = mapImage.width + 'px';
            mapContainer.style.height = mapImage.height + 'px';
        };
    });
</script>
{% endblock %} 